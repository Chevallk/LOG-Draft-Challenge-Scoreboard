<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxBvicwEohuNy72twGhT2r77TZA_XfBa_tUVxmKpQyqLn3dA9zPdgKQk_A8YjLfxtad/exec"; // Replace with your actual Web App URL

    function fetchScores() {
        fetch(API_URL)
            .then(response => response.json())
            .then(data => {
                console.log("Raw API Response:", JSON.stringify(data, null, 2));

                if (!data || !data.data || data.data.length < 2) {
                    showMessage("No valid scores available");
                    return;
                }

                updateTable(data.data);
            })
            .catch(error => {
                console.error("Error fetching scores:", error);
                showMessage("Error loading scoreboard");
            });
    }

    function showMessage(message) {
        const tbody = document.querySelector("#scoreboard tbody");
        const header = document.querySelector("#table-header");
        tbody.innerHTML = `<tr><td colspan="7">${message}</td></tr>`;
        header.innerHTML = "";
    }

    function updateTable(data) {
        if (!Array.isArray(data) || data.length < 2) {
            showMessage("No scores available");
            return;
        }

        const header = data[0];
        let scores = data.slice(1);

        // Filter rows that match header length and have valid Total (last column)
        scores = scores.filter(row =>
            row.length === header.length &&
            !isNaN(parseFloat(row[row.length - 1]))
        );

        // Sort by Total column (last column)
        scores.sort((a, b) => parseFloat(b[b.length - 1]) - parseFloat(a[a.length - 1]));

        // Build table header
        const headerRow = document.querySelector("#table-header");
        headerRow.innerHTML = "";
        header.forEach(title => {
            const th = document.createElement("th");
            th.textContent = title;
            headerRow.appendChild(th);
        });

        // Build table body
        const tbody = document.querySelector("#scoreboard tbody");
        tbody.innerHTML = "";
        scores.forEach(row => {
            const tr = document.createElement("tr");
            row.forEach(cell => {
                const td = document.createElement("td");
                td.textContent = cell ?? "-";
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    // Initial and auto refresh every 5 seconds
    fetchScores();
    setInterval(fetchScores, 5000);
</script>
